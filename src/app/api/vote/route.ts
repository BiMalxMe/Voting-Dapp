import { ActionGetResponse, ActionPostRequest, ACTIONS_CORS_HEADERS, createPostResponse } from "@solana/actions";
import { Connection, PublicKey, Transaction } from "@solana/web3.js";
import { Voting } from "@/../anchor/target/types/voting";
import { BN, Program, Wallet } from "@coral-xyz/anchor";

const IDL = require('@/../anchor/target/idl/voting.json');

export const OPTIONS = GET;

export async function GET(request: Request) {
  const ActionMetadata: ActionGetResponse = {
    icon: 'data:image/jpeg;base64,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',
            /** describes the source of the action request */
            title: 'Vote for your Favourite Chocolate',
            /** brief summary of the action to be performed */
            description: 'Both between DairyMilk and Kitkat',
            /** button text rendered to the user */
            label: 'Vote',
            links: {
              actions: [
                {
                  label: 'Vote for DairyMilk',
                  href: '/api/vote?candidate=Dairy',
                  type: 'transaction',
                },
                {
                  label: 'Vote for Kitkat',
                  href: '/api/vote?candidate=Kitkat',
                  type: 'transaction',
                },
              ],
            },
          }
  return Response.json(ActionMetadata, { headers: ACTIONS_CORS_HEADERS});
}

export async function POST(request: Request) {
  const url = new URL(request.url);
  const candidate = url.searchParams.get("candidate");

  if (candidate != "Dairy" && candidate != "KitKat") {
    return new Response("Invalid candidate", { status: 400, headers: ACTIONS_CORS_HEADERS });
  }

  const connection = new Connection("http://127.0.0.1:8899", "confirmed");
  const program: Program<Voting> = new Program(IDL, {connection});

  const body: ActionPostRequest = await request.json(); 
  let voter;

  try {
    voter = new PublicKey(body.account);
  } catch (error) {
    return new Response("Invalid account", { status: 400, headers: ACTIONS_CORS_HEADERS });
  }

  const instruction = await program.methods
    .vote(candidate, new BN(1))
    .accounts({
      signer: voter,
    })
    .instruction();

  const blockhash = await connection.getLatestBlockhash();

  const transaction = new Transaction({
      feePayer: voter,
      blockhash: blockhash.blockhash,
      lastValidBlockHeight: blockhash.lastValidBlockHeight,
    }).add(instruction);

  const response = await createPostResponse({
    fields: {
      transaction: transaction,
      type: "transaction"
    }
  });

  return Response.json(response, { headers: ACTIONS_CORS_HEADERS });

}